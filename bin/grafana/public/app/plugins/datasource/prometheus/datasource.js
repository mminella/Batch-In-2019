/*! grafana - v4.3.2 - 2017-05-31
 * Copyright (c) 2017 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","moment","app/core/utils/kbn","app/core/utils/datemath","./metric_find_query","app/core/table_model"],function(a,b){"use strict";function c(a,b,c,k,l){function m(a){return a.replace(/[\\^$*+?.()|[\]{}]/g,"\\\\$&")}this.type="prometheus",this.editorSrc="app/features/prometheus/partials/query.editor.html",this.name=a.name,this.supportMetrics=!0,this.url=a.url,this.directUrl=a.directUrl,this.basicAuth=a.basicAuth,this.withCredentials=a.withCredentials,this._request=function(a,b,d){var e={url:this.url+b,method:a,requestId:d};return(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth}),c.datasourceRequest(e)},this.interpolateQueryExpr=function(a,b,c){if(!b.multi&&!b.includeAll)return a;if("string"==typeof a)return m(a);var e=d.default.map(a,m);return e.join("|")},this.targetContainsTemplate=function(a){return k.variableExists(a.expr)},this.query=function(a){var c=this,e=this,f=this.getPrometheusTime(a.range.from,!1),g=this.getPrometheusTime(a.range.to,!0),h=[],i=[];a=d.default.clone(a);for(var j=0,l=a.targets;j<l.length;j++){var m=l[j];if(m.expr&&!m.hide){i.push(m);var n={};n.expr=k.replace(m.expr,a.scopedVars,e.interpolateQueryExpr),n.requestId=a.panelId+m.refId;var o=k.replace(m.interval,a.scopedVars)||a.interval,p=m.intervalFactor||1;m.step=n.step=this.calculateInterval(o,p);var q=Math.ceil(g-f);m.step=n.step=this.adjustStep(n.step,this.intervalSeconds(a.interval),q),h.push(n)}}if(d.default.isEmpty(h))return b.when({data:[]});var r=d.default.map(h,function(a){return c.performTimeSeriesQuery(a,f,g)});return b.all(r).then(function(a){var b=[];return d.default.each(a,function(a,c){if("error"===a.status)throw a.error;if("table"===i[c].format)b.push(e.transformMetricDataToTable(a.data.data.result));else for(var d=0,h=a.data.data.result;d<h.length;d++){var j=h[d];b.push(e.transformMetricData(j,i[c],f,g))}}),{data:b}})},this.adjustStep=function(a,b,c){return 0!==a&&c/a>11e3?Math.ceil(c/11e3):Math.max(a,b)},this.performTimeSeriesQuery=function(a,b,c){if(b>c)throw{message:"Invalid time range"};var d="/api/v1/query_range?query="+encodeURIComponent(a.expr)+"&start="+b+"&end="+c+"&step="+a.step;return this._request("GET",d,a.requestId)},this.performSuggestQuery=function(a){var b="/api/v1/label/__name__/values";return this._request("GET",b).then(function(b){return d.default.filter(b.data.data,function(b){return 1!==b.indexOf(a)})})},this.metricFindQuery=function(a){if(!a)return b.when([]);var c;try{c=k.replace(a,{},this.interpolateQueryExpr)}catch(a){return b.reject(a)}var d=new h.default(this,c,l);return d.process()},this.annotationQuery=function(a){var c=a.annotation,e=c.expr||"",g=c.tagKeys||"",h=c.titleFormat||"",i=c.textFormat||"";if(!e)return b.when([]);var j;try{j=k.replace(e,{},this.interpolateQueryExpr)}catch(a){return b.reject(a)}var l="60s";c.step&&(l=k.replace(c.step));var m=this.getPrometheusTime(a.range.from,!1),n=this.getPrometheusTime(a.range.to,!0),o={expr:j,step:this.adjustStep(f.default.interval_to_seconds(l),0,Math.ceil(n-m))+"s"},p=this;return this.performTimeSeriesQuery(o,m,n).then(function(a){var b=[];return g=g.split(","),d.default.each(a.data.data.result,function(a){var e=d.default.chain(a.metric).filter(function(a,b){return d.default.includes(g,b)}).value();d.default.each(a.values,function(d){if("1"===d[1]){var f={annotation:c,time:1e3*Math.floor(d[0]),title:p.renderTemplate(h,a.metric),tags:e,text:p.renderTemplate(i,a.metric)};b.push(f)}})}),b})},this.testDatasource=function(){return this.metricFindQuery("metrics(.*)").then(function(){return{status:"success",message:"Data source is working",title:"Success"}})},this.calculateInterval=function(a,b){return Math.ceil(this.intervalSeconds(a)*b)},this.intervalSeconds=function(a){var b=a.match(j),c=e.default.duration(parseInt(b[1]),b[2]),d=c.asSeconds();return d<1&&(d=1),d},this.transformMetricData=function(a,b,c,e){var f=[],g=null;g=this.createMetricLabel(a.metric,b);var h=1e3*parseInt(b.step),i=1e3*c;d.default.each(a.values,function(a){var b=parseFloat(a[1]);d.default.isNaN(b)&&(b=null);for(var c=1e3*a[0],e=i;e<c;e+=h)f.push([null,e]);i=c+h,f.push([b,c])});for(var j=1e3*e,k=i;k<=j;k+=h)f.push([null,k]);return{target:g,datapoints:f}},this.transformMetricDataToTable=function(a){var b,c=new i.default;return 0===a.length?c:(d.default.each(a,function(a,e){if(0===e&&(c.columns.push({text:"Time",type:"time"}),d.default.each(d.default.keys(a.metric),function(a){c.columns.push({text:a})}),c.columns.push({text:"Value"})),a.values)for(b=0;b<a.values.length;b++){var f=a.values[b],g=[1e3*f[0]];if(a.metric)for(var h in a.metric)a.metric.hasOwnProperty(h)&&g.push(a.metric[h]);g.push(parseFloat(f[1])),c.rows.push(g)}}),c)},this.createMetricLabel=function(a,b){return d.default.isUndefined(b)||d.default.isEmpty(b.legendFormat)?this.getOriginalMetricName(a):this.renderTemplate(k.replace(b.legendFormat),a)||"{}"},this.renderTemplate=function(a,b){var c=/\{\{\s*(.+?)\s*\}\}/g;return a.replace(c,function(a,c){return b[c]?b[c]:c})},this.getOriginalMetricName=function(a){var b=a.__name__||"";delete a.__name__;var c=d.default.map(d.default.toPairs(a),function(a){return a[0]+'="'+a[1]+'"'}).join(",");return b+"{"+c+"}"},this.getPrometheusTime=function(a,b){return d.default.isString(a)&&(a=g.parse(a,b)),Math.ceil(a.valueOf()/1e3)}}c.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"];b&&b.id;a("PrometheusDatasource",c);var d,e,f,g,h,i,j;return{setters:[function(a){d=a},function(a){e=a},function(a){f=a},function(a){g=a},function(a){h=a},function(a){i=a}],execute:function(){j=/(\d+)(ms|s|m|h|d|w|M|y)/}}});